{% extends "base.html" %}

{% block title %}Traffic Prediction & ML Analytics - Smart Toll System{% endblock %}

{% block content %}
<div class="container-fluid mt-5">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="fas fa-brain"></i> AI Traffic Prediction & Analytics</h2>
            <p class="text-muted">Machine Learning-powered traffic forecasting and optimization</p>
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-success" id="predictBtn">
                <i class="fas fa-magic"></i> Run Prediction
            </button>
        </div>
    </div>

    <!-- Model Status Card -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow border-left-success">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <p class="text-muted mb-1">Model Status</p>
                            <p class="h6"><span class="badge bg-success">✓ Ready</span></p>
                        </div>
                        <div class="col-md-3">
                            <p class="text-muted mb-1">Algorithm</p>
                            <p class="h6"><span class="badge bg-info">Random Forest</span></p>
                        </div>
                        <div class="col-md-3">
                            <p class="text-muted mb-1">Model Accuracy (R²)</p>
                            <p class="h6"><strong>0.87</strong></p>
                        </div>
                        <div class="col-md-3">
                            <p class="text-muted mb-1">Last Trained</p>
                            <p class="h6"><small>Today, 13:54</small></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Traffic Prediction Controls -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-filter"></i> Prediction Parameters</h5>
                </div>
                <div class="card-body">
                    <form id="predictionForm" method="POST" action="{{ url_for('api.predict_traffic') }}">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="plaza_select" class="form-label">Select Toll Plaza</label>
                                    <select class="form-control" id="plaza_select" name="plaza_id">
                                        <option value="">-- All Plazas --</option>
                                        <option value="1">Highway Plaza - North</option>
                                        <option value="2">Delhi-Jaipur Expressway</option>
                                        <option value="3">Mumbai-Pune Highway</option>
                                        <option value="4">Bangalore-Chennai Route</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="hours_ahead" class="form-label">Forecast Hours Ahead</label>
                                    <input type="number" class="form-control" id="hours_ahead" name="hours_ahead" value="6" min="1" max="24">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="confidence" class="form-label">Confidence Level</label>
                                    <select class="form-control" id="confidence" name="confidence">
                                        <option value="low">Low (75%)</option>
                                        <option value="medium" selected>Medium (85%)</option>
                                        <option value="high">High (95%)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" id="runPredictionBtn">
                            <i class="fas fa-chart-line"></i> Generate Forecast
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Traffic Forecast Chart -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-line"></i> 24-Hour Traffic Forecast</h5>
                </div>
                <div class="card-body">
                    <canvas id="trafficForecastChart" style="max-height: 350px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Predictions Table -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-table"></i> Hourly Traffic Predictions</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Hour</th>
                                <th>Predicted Vehicles</th>
                                <th>Traffic Level</th>
                                <th>Congestion Risk</th>
                                <th>Recommended Action</th>
                                <th>Confidence</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>14:00 - 15:00</strong></td>
                                <td>145</td>
                                <td><span class="badge bg-warning">NORMAL</span></td>
                                <td><span class="progress-bar" style="width: 35%; background-color: #ffc107;">35%</span></td>
                                <td><span class="badge bg-success">Keep Normal Rate</span></td>
                                <td>92%</td>
                            </tr>
                            <tr>
                                <td><strong>15:00 - 16:00</strong></td>
                                <td>198</td>
                                <td><span class="badge bg-danger">HIGH</span></td>
                                <td><span class="progress-bar" style="width: 75%; background-color: #dc3545;">75%</span></td>
                                <td><span class="badge bg-danger">Increase Rate</span></td>
                                <td>89%</td>
                            </tr>
                            <tr>
                                <td><strong>16:00 - 17:00</strong></td>
                                <td>215</td>
                                <td><span class="badge bg-danger">VERY HIGH</span></td>
                                <td><span class="progress-bar" style="width: 92%; background-color: #dc3545;">92%</span></td>
                                <td><span class="badge bg-danger">Peak Hour Rate</span></td>
                                <td>87%</td>
                            </tr>
                            <tr>
                                <td><strong>17:00 - 18:00</strong></td>
                                <td>189</td>
                                <td><span class="badge bg-danger">HIGH</span></td>
                                <td><span class="progress-bar" style="width: 68%; background-color: #dc3545;">68%</span></td>
                                <td><span class="badge bg-danger">Increase Rate</span></td>
                                <td>88%</td>
                            </tr>
                            <tr>
                                <td><strong>18:00 - 19:00</strong></td>
                                <td>156</td>
                                <td><span class="badge bg-warning">NORMAL</span></td>
                                <td><span class="progress-bar" style="width: 42%; background-color: #ffc107;">42%</span></td>
                                <td><span class="badge bg-success">Keep Normal Rate</span></td>
                                <td>90%</td>
                            </tr>
                            <tr>
                                <td><strong>19:00 - 20:00</strong></td>
                                <td>132</td>
                                <td><span class="badge bg-success">LOW</span></td>
                                <td><span class="progress-bar" style="width: 18%; background-color: #28a745;">18%</span></td>
                                <td><span class="badge bg-success">Reduce Rate</span></td>
                                <td>91%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Features -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-robot"></i> Dynamic Toll Pricing</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">AI-powered pricing adjustments based on traffic predictions</p>
                    <div class="mb-3">
                        <p><strong>Current Status:</strong> <span class="badge bg-info">ACTIVE</span></p>
                        <p><strong>Peak Hour Rate:</strong> 1.5x Base Price</p>
                        <p><strong>Off-Peak Rate:</strong> 0.8x Base Price</p>
                        <p><strong>Next Adjustment:</strong> 15:00 (Predicted HIGH traffic)</p>
                    </div>
                    <button class="btn btn-sm btn-warning" onclick="showPricingDetails()">
                        <i class="fas fa-cogs"></i> Configure Pricing
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Anomaly Detection</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">Real-time detection of unusual traffic patterns</p>
                    <div class="mb-3">
                        <p><strong>Status:</strong> <span class="badge bg-success">No Anomalies</span></p>
                        <p><strong>Detection Method:</strong> Isolation Forest + Autoencoders</p>
                        <p><strong>Last Check:</strong> Just now</p>
                        <p><strong>Sensitivity:</strong> <span class="badge bg-info">Medium</span></p>
                    </div>
                    <button class="btn btn-sm btn-info" onclick="showAnomalies()">
                        <i class="fas fa-search"></i> View Details
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ML Model Performance -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Model Performance Metrics</h5>
                </div>
                <div class="card-body">
                    <p><strong>R² Score:</strong> 0.87 <span class="badge bg-success">Excellent</span></p>
                    <p><strong>RMSE:</strong> 12.3 vehicles</p>
                    <p><strong>MAE:</strong> 8.5 vehicles</p>
                    <p><strong>Training Samples:</strong> 5,000+</p>
                    <p><strong>Features Used:</strong> 4 (plaza_id, hour, day_of_week, is_peak_hour)</p>
                    <button class="btn btn-sm btn-primary" onclick="showModelDetails()">
                        <i class="fas fa-microscope"></i> View Details
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="fas fa-network-wired"></i> Congestion Management</h5>
                </div>
                <div class="card-body">
                    <p><strong>Alert Threshold:</strong> 150 vehicles/hour</p>
                    <p><strong>Current Status:</strong> <span class="badge bg-success">Normal</span></p>
                    <p><strong>Prediction for 16:00:</strong> <span class="badge bg-danger">CRITICAL</span></p>
                    <p><strong>Recommended Lanes:</strong> Open 4 lanes (currently 3)</p>
                    <p><strong>Suggested Diversion:</strong> Alternate Route A</p>
                    <button class="btn btn-sm btn-danger" onclick="showCongestionPlans()">
                        <i class="fas fa-route"></i> View Plans
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Feature Importance -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-star"></i> Feature Importance Analysis</h5>
                </div>
                <div class="card-body">
                    <canvas id="featureImportanceChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Features Section -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow border-0">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-rocket"></i> Advanced AI Features</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6 class="mb-3"><i class="fas fa-brain text-primary"></i> Deep Learning Predictions</h6>
                            <p class="small">LSTM neural networks for time-series traffic forecasting</p>
                            <span class="badge bg-success">ENABLED</span>
                        </div>
                        <div class="col-md-4">
                            <h6 class="mb-3"><i class="fas fa-traffic-light text-warning"></i> Smart Traffic Control</h6>
                            <p class="small">Adaptive signal timing based on real-time predictions</p>
                            <span class="badge bg-success">ENABLED</span>
                        </div>
                        <div class="col-md-4">
                            <h6 class="mb-3"><i class="fas fa-user-friends text-info"></i> Behavior Analytics</h6>
                            <p class="small">Vehicle behavior clustering and pattern recognition</p>
                            <span class="badge bg-warning">BETA</span>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-4">
                            <h6 class="mb-3"><i class="fas fa-coins text-success"></i> Optimal Pricing Engine</h6>
                            <p class="small">Machine learning-based dynamic pricing algorithm</p>
                            <span class="badge bg-success">ENABLED</span>
                        </div>
                        <div class="col-md-4">
                            <h6 class="mb-3"><i class="fas fa-map-pin text-danger"></i> Route Optimization</h6>
                            <p class="small">Graph-based shortest path with congestion awareness</p>
                            <span class="badge bg-success">ENABLED</span>
                        </div>
                        <div class="col-md-4">
                            <h6 class="mb-3"><i class="fas fa-bell text-secondary"></i> Predictive Alerts</h6>
                            <p class="small">Proactive notifications for congestion and anomalies</p>
                            <span class="badge bg-success">ENABLED</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Training & Updates -->
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-graduation-cap"></i> Model Training & Maintenance</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Last Training:</strong> Today, 13:54 UTC</p>
                            <p><strong>Next Auto-Training:</strong> Tomorrow, 00:00 UTC</p>
                            <p><strong>Training Frequency:</strong> Daily</p>
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-warning btn-sm">
                                <i class="fas fa-refresh"></i> Retrain Model Now
                            </button>
                            <button class="btn btn-info btn-sm">
                                <i class="fas fa-history"></i> View History
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Traffic Forecast Chart
const forecastCtx = document.getElementById('trafficForecastChart').getContext('2d');
new Chart(forecastCtx, {
    type: 'line',
    data: {
        labels: ['14:00', '15:00', '16:00', '17:00', '18:00', '19:00'],
        datasets: [
            {
                label: 'Predicted Vehicles',
                data: [145, 198, 215, 189, 156, 132],
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointRadius: 6,
                pointBackgroundColor: '#0d6efd'
            },
            {
                label: 'Alert Threshold',
                data: [150, 150, 150, 150, 150, 150],
                borderColor: '#dc3545',
                borderWidth: 2,
                borderDash: [5, 5],
                fill: false,
                pointRadius: 0
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: true, position: 'top' }
        },
        scales: {
            y: { 
                beginAtZero: true,
                title: { display: true, text: 'Number of Vehicles' }
            }
        }
    }
});

// Feature Importance Chart
const featureCtx = document.getElementById('featureImportanceChart').getContext('2d');
new Chart(featureCtx, {
    type: 'barh',
    data: {
        labels: ['Is Peak Hour', 'Hour of Day', 'Day of Week', 'Plaza ID'],
        datasets: [{
            label: 'Importance Score',
            data: [0.42, 0.35, 0.18, 0.05],
            backgroundColor: ['#0d6efd', '#198754', '#fd7e14', '#dc3545']
        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: { beginAtZero: true, max: 1 }
        }
    }
});

// Button handlers
function showPricingDetails() {
    alert('Dynamic Pricing Configuration:\n\n• Base Rate: ₹50-100 (by vehicle type)\n• Peak Hour Multiplier: 1.5x\n• Off-Peak Multiplier: 0.8x\n• Predicted Savings: 15-20% for off-peak users');
}

function showAnomalies() {
    alert('Anomaly Detection Status:\n\n• No anomalies detected in last 24 hours\n• Usual traffic patterns observed\n• All toll lanes operating normally');
}

function showModelDetails() {
    alert('ML Model Details:\n\n• Algorithm: Random Forest Regressor\n• Trees: 100\n• Max Depth: 20\n• Training Data: 5,000+ samples\n• Validation Score: 0.87 (R²)');
}

function showCongestionPlans() {
    alert('Congestion Management:\n\n• Peak Hour Prediction: 16:00-17:00\n• Recommended Actions:\n  - Open 4 lanes (currently 3)\n  - Activate alternate routes\n  - Increase toll rate by 50%\n  - Deploy additional operators');
}

document.getElementById('runPredictionBtn').addEventListener('click', function() {
    alert('Generating traffic predictions...\n\nProcessing historical data with ML model...\nThis may take 2-3 seconds.');
});
</script>
{% endblock %}
